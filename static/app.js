function g(o,e=!1,t){{console.warn("Feedback element not provided to showFeedback");return}}function E(o){document.querySelectorAll("button").forEach(t=>{t.disabled=o}),o&&console.log("Loading...")}const C=`${MOKKAPI_ADMIN_PREFIX}api/`;async function F(o,e="GET",t=null){const s=`${C}${o}`,a={"Content-Type":"application/json","X-CSRFToken":CSRF_TOKEN,Accept:"application/json"},d={method:e,headers:a,mode:"same-origin"};t&&e!=="GET"&&e!=="HEAD"&&(d.body=JSON.stringify(t)),showLoading(!0);try{const r=await fetch(s,d);if(r.status===204)return null;let n;const l=r.headers.get("content-type");if(l&&l.indexOf("application/json")!==-1)n=await r.json();else if(r.ok)n=await r.text();else{const c=await r.text();throw new Error(c||`Request failed with status ${r.status}`)}if(!r.ok){let c=(n==null?void 0:n.detail)||(n==null?void 0:n.error)||`Request failed with status ${r.status}`;typeof c=="object"&&c!==null&&(c=Object.entries(c).map(([u,m])=>`${u}: ${Array.isArray(m)?m.join(", "):m}`).join("; "));const p=new Error(c);throw p.response={data:n,status:r.status},p}return n}catch(r){throw console.error(`API call failed: ${e} ${s}`,r),r}finally{showLoading(!1)}}function B(){return F("endpoints/")}function b(o){const e=document.createElement("ul");return e.className="list-none pl-0 text-sm",o.forEach(t=>{const s=document.createElement("li");s.className="mb-1";const a=document.createElement("div");a.className="flex items-center p-1 rounded hover:bg-gray-200 transition-colors duration-150";const d=document.createElement("span");d.className="mr-1 w-4 text-center",t.children&&t.children.length>0?(d.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline transition-transform duration-150" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>',d.style.cursor="pointer",d.addEventListener("click",n=>{n.stopPropagation();const l=s.querySelector("ul"),c=d.querySelector("svg");if(l){const p=l.style.display==="block";l.style.display=p?"none":"block",c.style.transform=p?"rotate(0deg)":"rotate(90deg)"}})):d.innerHTML='<span class="text-gray-400">&bull;</span>',a.appendChild(d);const r=document.createElement("span");if(r.textContent=t.name,r.className="flex-1 truncate",t.is_endpoint){r.classList.add("text-blue-600","cursor-pointer","font-medium"),r.title=`Click to view /${t.path}`,r.addEventListener("click",l=>{l.stopPropagation(),showEndpointDetails(t.endpoint_details),hideEndpointForm(),hideHandlerForm(),hideAuthManagement()});const n=document.createElement("span");n.className="ml-2 flex-shrink-0",t.endpoint_details.authentication_profile_id&&(n.innerHTML+='<span class="bg-yellow-100 text-yellow-800 text-xs font-semibold mr-1 px-1.5 py-0.5 rounded border border-yellow-300" title="Auth Required">Auth</span>'),t.endpoint_details.handlers&&t.endpoint_details.handlers.forEach(l=>{const c=getBadgeClass(l.http_method);n.innerHTML+=`<span class="${c} text-xs font-semibold mr-1 px-1.5 py-0.5 rounded border" title="${l.http_method}">${l.http_method}</span>`}),a.appendChild(r),a.appendChild(n)}else r.classList.add("text-gray-600"),r.title=`Intermediate path: ${t.path}`,a.appendChild(r);if(s.appendChild(a),t.children&&t.children.length>0){const n=b(t.children);n.style.display="none",n.className="list-none pl-5",s.appendChild(n)}e.appendChild(s)}),e}function I(){selectors.tabContentEndpoints.style.display="block",selectors.tabContentAuth.style.display="none",selectors.tabEndpointsLink.classList.add("border-indigo-500","text-indigo-600"),selectors.tabEndpointsLink.classList.remove("border-transparent","text-gray-500","hover:text-gray-700","hover:border-gray-300"),selectors.tabEndpointsLink.setAttribute("aria-current","page"),selectors.tabAuthLink.classList.add("border-transparent","text-gray-500","hover:text-gray-700","hover:border-gray-300"),selectors.tabAuthLink.classList.remove("border-indigo-500","text-indigo-600"),selectors.tabAuthLink.removeAttribute("aria-current"),v(),w()}function x(){selectors.tabContentEndpoints.style.display="none",selectors.tabContentAuth.style.display="block",selectors.tabAuthLink.classList.add("border-indigo-500","text-indigo-600"),selectors.tabAuthLink.classList.remove("border-transparent","text-gray-500","hover:text-gray-700","hover:border-gray-300"),selectors.tabAuthLink.setAttribute("aria-current","page"),selectors.tabEndpointsLink.classList.add("border-transparent","text-gray-500","hover:text-gray-700","hover:border-gray-300"),selectors.tabEndpointsLink.classList.remove("border-indigo-500","text-indigo-600"),selectors.tabEndpointsLink.removeAttribute("aria-current")}function v(){selectors.endpointFormContainer.style.display="none",selectors.endpointForm.reset(),currentEditingEndpoint=null,L()}function w(){selectors.handlerFormContainer.style.display="none",selectors.handlerForm.reset(),currentEditingHandler=null,L()}function L(){selectors.endpointFormContainer.style.display==="none"&&selectors.handlerFormContainer.style.display==="none"&&selectors.detailsContainer.style.display==="none"&&(selectors.titleElement.innerText="Select or Create Endpoint",selectors.detailsContainer.innerHTML='<p class="text-gray-600">Click an endpoint from the tree to see its details, or click "Create New Endpoint".</p>',selectors.detailsContainer.style.display="block")}function _(o,e=null){hideDetails(),hideHandlerForm(),hideAuthManagement(),currentEditingEndpoint=null,selectors.endpointForm.reset(),selectors.endpointFormMode.value=o,selectors.endpointPathInput.readOnly=o==="edit",selectors.initialHandlerSection.style.display="block",selectors.endpointFormTitle.innerText="Create New Endpoint",selectors.endpointIdInput.value="",selectors.feedbackDiv.innerHTML="",selectors.endpointFormContainer.style.display="block",selectors.titleElement.innerText=selectors.endpointFormTitle.innerText,selectors.endpointPathInput.focus()}async function A(o){o.preventDefault(),showFeedback("Saving endpoint...",!1);const e=new FormData(selectors.endpointForm),t=selectors.endpointFormMode.value,s={path:e.get("path"),creator:USER,description:e.get("description"),authentication_profile_id:e.get("authentication_profile_id")||null,handlers:[]};if(t==="create"){const a=e.get("initial_http_method"),d=e.get("initial_response_body");if(!a){showFeedback("Initial handler method is required.",!0);return}s.handlers.push({http_method:a,response_status_code:200,response_headers:{"Content-Type":"application/json"},response_body:d||'{ "message": "Default Response" }',description:`${a} Handler (Initial)`})}showFeedback(`Error saving endpoint: ${error.message}`,!0);try{const a=await apiCall(HOME_URL,"POST",s);showFeedback(a.message||"Endpoint saved successfully.",!1),setTimeout(()=>{window.location.reload()},1500)}catch{}}function T(o,e=null,t){hideDetails(),hideEndpointForm(),hideAuthManagement(),currentEditingHandler=null,selectors.handlerForm.reset(),selectors.handlerFormMode.value=o,selectors.handlerEndpointIdInput.value=t,selectors.handlerFormTitle.innerText="Create New Handler",selectors.handlerIdInput.value="",selectors.handlerMethodSelect.disabled=!1,selectors.feedbackDiv.innerHTML="",selectors.handlerFormContainer.style.display="block",selectors.titleElement.innerText=selectors.handlerFormTitle.innerText,selectors.handlerMethodSelect.focus()}async function H(o){o.preventDefault(),showFeedback("Saving handler...",!1);const e=new FormData(selectors.handlerForm),t=selectors.handlerFormMode.value,s=e.get("handler_id"),a=e.get("handler_endpoint_id");let d;try{const n=e.get("response_headers").trim();if(d=n?JSON.parse(n):{},typeof d!="object"||d===null||Array.isArray(d))throw new Error("Headers must be a JSON object (dictionary).")}catch(n){showFeedback(`Invalid JSON in Response Headers: ${n.message}`,!0);return}const r={action:t==="create"?"create_handler":"update_handler",handler_id:t==="edit"?s:null,endpoint_id:a,handler_data:{http_method:e.get("http_method"),response_status_code:parseInt(e.get("response_status_code"))||200,response_headers:d,response_body:e.get("response_body"),description:e.get("description")}};try{const n=await apiCall(HOME_URL,"POST",r);showFeedback(n.message||"Handler saved successfully.",!1),setTimeout(()=>{window.location.reload()},1500)}catch(n){showFeedback(`Error saving handler: ${n.message}`,!0)}}async function D(o,e,t){if(!confirm(`Are you sure you want to delete the ${e} handler for '/${t}'?`))return;showFeedback("Deleting handler...",!1);const s={action:"delete_handler",handler_id:o};try{const a=encodeURIComponent(t),d=await apiCall(`api/endpoints/${a}/handler/${o}/`,"DELETE",s);showFeedback(d.message||"Handler deleted successfully.",!1),setTimeout(()=>{window.location.reload()},1500)}catch(a){showFeedback(`Error deleting handler: ${a.message}`,!0)}}document.addEventListener("DOMContentLoaded",()=>{S()});let y=null,i={};function M(){i={treeContainer:document.getElementById("tree-container"),resizer:document.getElementById("resizer"),sidebar:document.getElementById("sidebar"),mainContent:document.getElementById("main-content"),titleElement:document.getElementById("endpoint-title"),createNewBtn:document.getElementById("create-new-btn"),tabEndpointsLink:document.getElementById("tab-endpoints"),tabAuthLink:document.getElementById("tab-auth"),tabContentEndpoints:document.getElementById("tab-content-endpoints"),tabContentAuth:document.getElementById("tab-content-auth"),detailsContainer:document.getElementById("endpoint-details"),endpointFormContainer:document.getElementById("endpoint-form-container"),endpointForm:document.getElementById("endpoint-form"),endpointFormTitle:document.getElementById("endpoint-form-title"),endpointFormMode:document.getElementById("endpoint-form-mode"),endpointIdInput:document.getElementById("endpoint-id"),endpointPathInput:document.getElementById("endpoint-path-input"),endpointDescriptionInput:document.getElementById("endpoint-description-input"),endpointAuthSelect:document.getElementById("endpoint-auth-select"),initialHandlerSection:document.getElementById("initial-handler-section"),saveEndpointBtn:document.getElementById("save-endpoint-btn"),cancelEndpointBtn:document.getElementById("cancel-endpoint-edit-btn"),handlerFormContainer:document.getElementById("handler-form-container"),handlerForm:document.getElementById("handler-form"),handlerFormTitle:document.getElementById("handler-form-title"),handlerFormMode:document.getElementById("handler-form-mode"),handlerIdInput:document.getElementById("handler-id"),handlerEndpointIdInput:document.getElementById("handler-endpoint-id"),handlerMethodSelect:document.getElementById("handler-method-select"),handlerStatusInput:document.getElementById("handler-status-input"),handlerHeadersInput:document.getElementById("handler-headers-input"),handlerBodyInput:document.getElementById("handler-body-input"),handlerDescriptionInput:document.getElementById("handler-description-input"),saveHandlerBtn:document.getElementById("save-handler-btn"),cancelHandlerBtn:document.getElementById("cancel-handler-edit-btn"),createAuthProfileBtn:document.getElementById("create-auth-profile-btn"),authProfileList:document.getElementById("auth-profile-list"),authProfileFormContainer:document.getElementById("auth-profile-form-container"),authFeedback:document.getElementById("auth-feedback-message"),feedbackDiv:document.getElementById("feedback-message")}}async function S(){M(),$(),await O(),I()}function $(){var o,e,t,s,a,d,r,n,l,c;if(i.resizer&&i.sidebar){let p=0,u=i.sidebar.offsetWidth;const m=h=>{const k=h.clientX-p;u=i.sidebar.offsetWidth+k,u<150&&(u=150),u>600&&(u=600),i.sidebar.style.width=u+"px",p=h.clientX},f=()=>{document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",f)};i.resizer.addEventListener("mousedown",h=>{p=h.clientX,document.addEventListener("mousemove",m),document.addEventListener("mouseup",f)})}(o=i.tabEndpointsLink)==null||o.addEventListener("click",p=>{p.preventDefault(),I()}),(e=i.tabAuthLink)==null||e.addEventListener("click",p=>{p.preventDefault(),x()}),(t=i.createNewBtn)==null||t.addEventListener("click",()=>_("create")),(s=i.endpointForm)==null||s.addEventListener("submit",A),(a=i.cancelEndpointBtn)==null||a.addEventListener("click",v),(d=i.handlerForm)==null||d.addEventListener("submit",H),(r=i.cancelHandlerBtn)==null||r.addEventListener("click",w),(n=i.createAuthProfileBtn)==null||n.addEventListener("click",()=>{alert("Auth Profile Create form not implemented yet.")}),(l=i.detailsContainer)==null||l.addEventListener("click",N),(c=i.authProfileList)==null||c.addEventListener("click",P)}function N(o){const e=o.target;if(e.id==="edit-endpoint-btn")e.dataset.endpointId,console.error("Couldn't find endpoint data for edit");else if(e.id==="delete-endpoint-btn-main")console.error("Couldn't find endpoint ID for delete");else if(e.id==="add-handler-btn"){const t=e.dataset.endpointId;T("create",null,t)}else if(e.classList.contains("edit-handler-btn"))e.dataset.handlerId,console.error("Couldn't find endpoint ID for handler edit");else if(e.classList.contains("delete-handler-btn")){const t=e.dataset.handlerId,s=e.dataset.method,a=y==null?void 0:y.path;D(t,s,a)}}function P(o){const e=o.target;if(e.classList.contains("edit-auth-btn")){const t=e.dataset.profileId;alert(`Edit Auth Profile ${t} - Not implemented.`)}else if(e.classList.contains("delete-auth-btn")){const t=e.dataset.profileId;alert(`Delete Auth Profile ${t} - Not implemented.`)}}async function O(){E(!0);try{const o=await B(),e=ENDPOINTS_DATA;e&&Array.isArray(e)?(i.treeContainer.innerHTML="",i.treeContainer.appendChild(b(e))):i.treeContainer.innerHTML='<p class="text-gray-500 text-sm">No endpoints defined yet.</p>',g("Endpoints loaded.",!1)}catch(o){g(`Error loading endpoints: ${o.message}`,!0),i.treeContainer.innerHTML='<p class="text-red-500 text-sm">Could not load endpoints.</p>'}finally{E(!1)}}

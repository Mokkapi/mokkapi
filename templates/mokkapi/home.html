{% extends 'mokkapi/base.html' %}
{% load static %}
{% block title %}Mokkapi Home{% endblock %}

{% block content %}
  <div class="container mx-auto px-4 py-4">

    <div id="layout" class="flex border rounded shadow-sm" style="height: 80vh;">
      <aside id="sidebar" class="bg-gray-100 border-r p-3 w-64 h-full overflow-y-auto">
        <div class="pt-1">
          <h5 class="px-3 font-semibold text-lg mb-2">API Endpoints</h5>
          <div id="tree-container" class="px-1"></div>
        </div>
      </aside>
      
      <div id="resizer" class="w-1.5 cursor-ew-resize bg-gray-300 hover:bg-gray-400 transition-colors duration-150"></div>

      <main role="main" id="main-content" class="flex-1 pt-3 px-4 min-h-0 h-full overflow-y-auto">
          <div class="mb-4 border-b border-gray-200 sticky top-0 bg-white z-10">
              <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                  <a href="#" id="tab-endpoints" class="border-indigo-500 text-indigo-600 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" aria-current="page">Endpoints</a>
                  <a href="#" id="tab-auth" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Authentication</a>
              </nav>
          </div>
 
          <div id="tab-content-endpoints">
            <button id="create-new-btn" class="bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded mb-3 text-sm">
              Create New Endpoint
            </button>
            <h2 id="endpoint-title" class="mb-3 text-xl font-semibold">Select or Create Endpoint</h2>
              <div id="endpoint-details">
                  <p class="text-gray-600">Click an endpoint from the tree to see details, or click "Create New Endpoint".</p>
              </div>


              <div id="endpoint-form-container" class="hidden border p-4 rounded bg-gray-50 mt-4">
                  <form id="endpoint-form">
                     {% csrf_token %}
                     <input type="hidden" id="endpoint-form-mode" value="create">
                     <input type="hidden" id="endpoint-id" value=""> <div class="mb-4">
                         <label for="endpoint-path-input" class="block font-medium text-sm mb-1">Endpoint Path:</label>
                         <input type="text" id="endpoint-path-input" name="path" class="border border-gray-300 rounded px-3 py-2 w-full text-sm" placeholder="e.g., users/profile" required>
                         <p class="text-xs text-gray-500 mt-1">Unique path fragment.</p>
                     </div>
                     <div class="mb-4">
                         <label for="endpoint-description-input" class="block font-medium text-sm mb-1">Description:</label>
                         <textarea id="endpoint-description-input" name="description" class="border border-gray-300 rounded px-3 py-2 w-full text-sm" rows="2"></textarea>
                     </div>
           
                     <div id="initial-handler-section" class="mt-4 border-t pt-3">
                         <h5 class="font-semibold text-base mb-2">Initial Handler (Required for Create)</h5>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div class="mb-3">
                              <label class="block font-medium text-sm mb-1">HTTP Method:</label>
                              <select name="initial_http_method" class="border border-gray-300 rounded px-3 py-2 w-full text-sm">
                                  <option>GET</option>
                                  <option>POST</option>
                                  <option>PUT</option>
                                  <option>PATCH</option>
                                  <option>DELETE</option>
                              </select>
                         </div>
                          <div class="mb-3 md:col-span-2">
                              <label class="block font-medium text-sm mb-1">Response Body (e.g., JSON string):</label>
                              <textarea name="initial_response_body" class="border border-gray-300 rounded px-3 py-2 w-full font-mono text-xs" rows="5">{ "message": "Default Response" }</textarea>
                          </div>
                      </div>
                      <p class="text-xs text-gray-500 mt-1">Set Status/Headers via "Edit Handler" after creation.</p>
                  </div>
                  <div id="feedback-message" class="mt-3 text-sm"></div>
                  <div class="mt-4">
                     <button type="submit" id="save-endpoint-btn" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded text-sm">Save Endpoint</button>
                     <button type="button" id="cancel-endpoint-edit-btn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded ml-2 text-sm">Cancel</button>
                  </div>
              </form>
          </div>
           
               <div id="handler-form-container" class="hidden border p-4 rounded bg-gray-50 mt-4">
                    <h4 id="handler-form-title" class="text-lg font-semibold mb-3">Handler Form</h4>
                    <form id="handler-form">
                       {% csrf_token %} 
                       <input type="hidden" id="handler-form-mode" value="create">
                       <input type="hidden" id="handler-id" value=""> 
                       <input type="hidden" id="handler-endpoint-id" name="endpoint_id" value=""> 
                       <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                          <div>
                              <label class="block font-medium text-sm mb-1">HTTP Method:</label>
                              <select id="handler-method-select" name="http_method" class="border border-gray-300 rounded px-3 py-2 w-full text-sm" required>
                               <option>GET</option>
                               <option>POST</option>
                               <option>PUT</option>
                               <option>PATCH</option>
                               <option>DELETE</option>
                               <option>OPTIONS</option>
                               <option>HEAD</option>
                           </select>
                        </div>
                        <div>
                           <label class="block font-medium text-sm mb-1">Status Code:</label>
                           <input type="number" id="handler-status-input" name="response_status_code" value="200" min="100" max="599" class="border border-gray-300 rounded px-3 py-2 w-full text-sm" required>
                        </div>
                      </div>
                      <div class="mb-3">
                          <label class="block font-medium text-sm mb-1">Description:</label>
                          <input type="text" id="handler-description-input" name="description" class="border border-gray-300 rounded px-3 py-2 w-full text-sm" placeholder="Optional e.g., 'Get user profile'">
                       </div>
                       <div class="mb-3">
                        <label for="handler-auth-select" class="block font-medium text-sm mb-1">Auth Profiles:</label>
                        <select id="handler-auth-select" name="authentication_profile_ids" multiple
                                class="border border-gray-300 rounded px-3 py-2 w-full text-sm">
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Ctrl/Cmd+click to select multiple.</p>
                      </div>
                        <div class="mb-3">
                           <label for="handler-headers-input" class="block font-medium text-sm mb-1">Response Headers (JSON Object):</label>
                           <textarea id="handler-headers-input" name="response_headers" class="border border-gray-300 rounded px-3 py-2 w-full font-mono text-xs" rows="4" placeholder='{ "Content-Type": "application/json", "X-Custom-Header": "value" }'></textarea>
                           <p class="text-xs text-gray-500 mt-1">Enter valid JSON. Content-Type is recommended.</p>
                        </div>
                         <div class="mb-3">
                           <label for="handler-body-input" class="block font-medium text-sm mb-1">Response Body:</label>
                           <textarea id="handler-body-input" name="response_body" class="border border-gray-300 rounded px-3 py-2 w-full font-mono text-xs" rows="8" placeholder='{ "message": "Hello!" }'></textarea>
                           <p class="text-xs text-gray-500 mt-1">Ener the raw body (e.g., JSON, XML, text).</p>
                        </div>
                        <div id="feedback-message" class="mt-3 text-sm"></div>
                        <div class="mt-4">
                          <button type="submit" id="save-handler-btn" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded text-sm">Save Handler</button>
                          <button type="button" id="cancel-handler-edit-btn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded ml-2 text-sm">Cancel</button>
                      </div>
                    </form>
                </div>
          </div>
 
          <div id="tab-content-auth" class="hidden">
            <button id="create-auth-profile-btn" class="bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded mb-3 text-sm">
              Create New Profile
            </button>
            <h2 class="text-xl font-semibold mb-3">Authentication Profiles</h2>
            <div id="auth-details">
                <p class="text-gray-600">Edit or delete vailable authentication profiles below, or click "Create New Profile"</p>
              </div>
              <div id="auth-profile-list" class="mt-2">
                  <p class="text-gray-600">Loading authentication profiles...</p>
              </div>
              <div id="auth-profile-form-container" class="hidden mt-4 border p-4 rounded bg-gray-50"></div>
              <div id="auth-feedback-message" class="hidden mt-3 text-sm"></div>
          </div>
      </main>
    </div>

  </div>
  <script>
    // Pass Django context data needed by JS (like auth profiles, CSRF token)

    const CSRF_TOKEN = "{{ csrf_token }}";
    const MOKKAPI_ADMIN_PREFIX = "{{ mokkapi_core_prefix }}";
    const HOME_URL = "{% url 'home' %}";
    const USER = "{{ user.username }}";
  </script>
  <script src="{% static 'app.js' %}"></script>

{% endblock %}